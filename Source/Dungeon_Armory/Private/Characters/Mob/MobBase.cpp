// Fill out your copyright notice in the Description page of Project Settings.


#include "Characters/Mob/MobBase.h"

#include "Characters/Core/CharacterStatComponent.h"
#include "GameFramework/CharacterMovementComponent.h"
#include "AI/Team/TeamComponent.h"
#include "BehaviorTree/BlackboardComponent.h"

#include "AIController.h"

const FName AMobBase::MobStateKey(TEXT("MobState"));

// Sets default values
AMobBase::AMobBase()
{
	PrimaryActorTick.bCanEverTick = false;

	// 컨트롤러 회전 제어 해제
	bUseControllerRotationPitch = false;
	bUseControllerRotationYaw = false;
	bUseControllerRotationRoll = false;

	// 컨트롤러 회전은 무시
	GetCharacterMovement()->bUseControllerDesiredRotation = false;

	// 이동	방향으로 회전하도록 설정
	GetCharacterMovement()->bOrientRotationToMovement = true;

	// 회전 속도 설정 (원하는 속도로 조정)
	GetCharacterMovement()->RotationRate = FRotator(0.f, 480.f, 0.f);

	// 스탯 컴포넌트 생성
	StatComponent = CreateDefaultSubobject<UCharacterStatComponent>(TEXT("StatComponent"));

	// 팀 컴포넌트 생성
	TeamComponent = CreateDefaultSubobject<UTeamComponent>(TEXT("TeamComponent"));
	TeamComponent->SetTeamType(ETeamType::Mob);
}

// Called when the game starts or when spawned
void AMobBase::BeginPlay()
{
	Super::BeginPlay();
	
	MobAIController = Cast<AAIController>(GetController());
	if (MobAIController)
	{
		MobBlackboardComponent = MobAIController->GetBlackboardComponent();
	}
}

void AMobBase::GetActorEyesViewPoint(FVector& OutLocation, FRotator& OutRotation) const
{
	OutLocation = GetMesh()->GetSocketLocation(FName("EyeSocket"));	// 머리 위치를 기준으로 시점 설정
	OutRotation = GetMesh()->GetSocketRotation(FName("EyeSocket"));	// 머리 위치를 기준으로 시점 설정
}

void AMobBase::ApplySpeedModifier(float SpeedMultiplier, float Duration)
{
	//float NewSpeed = BaseSpeed * SpeedMultiplier;
	//SetMovementSpeed(NewSpeed);

	//// 일정 시간이 지나면 원래 속도로 복귀
	//GetWorldTimerManager().SetTimer(SpeedResetTimer, this, &ANPCCharacter::ResetSpeed, Duration, false);
}

void AMobBase::ResetSpeed()
{
	if (StatComponent)
	{
		SetSpeed(StatComponent->BaseSpeed);
	}
}

void AMobBase::SetSpeed(float NewSpeed)
{
	GetCharacterMovement()->MaxWalkSpeed = NewSpeed;
}

float AMobBase::GetSpeedForState(EMobState State) const
{
	switch (State)
	{
	case EMobState::Idle:    return StatComponent->BaseSpeed * StatComponent->IdleSpeedOffset;
	case EMobState::Patrol:  return StatComponent->BaseSpeed * StatComponent->PatrolSpeedOffset;
	case EMobState::Chase:   return StatComponent->BaseSpeed * StatComponent->ChaseSpeedOffset;
	case EMobState::Battle:  return StatComponent->BaseSpeed * StatComponent->CombatSpeedOffset;
	case EMobState::Dead:    return StatComponent->BaseSpeed * StatComponent->DeadSpeedOffset;
	default:				 return StatComponent->BaseSpeed;
	}
}

void AMobBase::SetSpeedForState(EMobState State)
{
	float ChangedSpeed = GetSpeedForState(State);
	SetSpeed(ChangedSpeed);
}

void AMobBase::SetMobState(EMobState NewState)
{
	if (CurrentState == NewState)
	{
		return;  // 동일 상태로의 변경은 무시
	}

	CurrentState = NewState;

	// 블랙보드에 상태 업데이트
	if (MobBlackboardComponent)
	{
		MobBlackboardComponent->SetValueAsEnum(MobStateKey, static_cast<uint8>(NewState));
	}
}

void AMobBase::ApplyDamage(float DamageAmount)
{
	StatComponent->CurrentHealth = FMath::Clamp(StatComponent->CurrentHealth - DamageAmount, 0.f, StatComponent->MaxHealth);
}

bool AMobBase::IsDead() const
{
	return StatComponent->CurrentHealth <= 0.f;
}